{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://eccenca.com/marketplace/manifest-schema.json",
  "title": "Package Manifest",
  "description": "Schema for eccenca Marketplace package manifests",
  "oneOf": [
    { "$ref": "#/$defs/VocabularyPackageManifest" },
    { "$ref": "#/$defs/ProjectPackageManifest" }
  ],
  "$defs": {
    "PackageIdentifier": {
      "type": "string",
      "title": "Package Identifier",
      "description": "Unique package identifier",
      "pattern": "^[a-z][a-z0-9]{1,19}(-[a-z][a-z0-9]{0,19}){1,4}$",
      "examples": ["ecc-pv-vocab", "w3c-rdfs-vocab", "ecc-product-data-project"]
    },
    "PackageVersionIdentifier": {
      "type": "string",
      "title": "Package Version",
      "description": "Semantic version identifier string of the package, limited to proper releases (MAJOR.MINOR.PATCH).",
      "pattern": "^(0|[1-9]\\d{0,2})\\.(0|[1-9]\\d{0,2})\\.(0|[1-9]\\d{0,2})$",
      "examples": ["1.0.0", "14.4.1"]
    },
    "PackageName": {
      "type": "string",
      "title": "Package Name",
      "description": "The package name in english.",
      "minLength": 3,
      "maxLength": 50,
      "examples": ["Nextcloud Integration", "RDF Schema", "My Nice Package"]
    },
    "PackageDescription": {
      "type": "string",
      "title": "Package Description",
      "description": "The package description in english.",
      "minLength": 10,
      "maxLength": 150,
      "examples": [
        "Extract and process data from your Nextcloud instance.",
        "A set of classes with certain properties providing basic elements for the description of ontologies."
      ]
    },
    "PackageComment": {
      "title": "Package Comment",
      "description": "A maintainer or publisher comment on the package.",
      "oneOf": [
        {
          "type": "string",
          "maxLength": 300
        },
        {
          "type": "null"
        }
      ]
    },
    "ResourceIdentifier": {
      "type": "string",
      "title": "Resource Identifier (IRI)",
      "description": "Identifier for subjects in a Knowledge Graph.",
      "format": "uri",
      "examples": [
        "https://example.org/graph/",
        "urn:x-example:graph/",
        "https://my-schema.org/vocab#"
      ]
    },
    "FileSpecFilePath": {
      "type": "string",
      "title": "File Path",
      "description": "A relative path of a file inside of the package archive.",
      "pattern": "^[0-9a-z][0-9a-z-_.]{1,29}(/[0-9a-z][0-9a-z-_.]{1,29})?\\.(zip|ttl)$",
      "examples": ["graphs/my-graph.ttl", "projects/my-project.zip"]
    },
    "PyPiIdentifier": {
      "type": "string",
      "title": "PyPI Identifier",
      "description": "A Python distribution name as defined in PEP 345. Must start with 'cmem-plugin-'.",
      "pattern": "^cmem-plugin-.*$"
    },
    "ManifestMetadata": {
      "type": "object",
      "title": "Package Metadata",
      "description": "Metadata describing the package.",
      "additionalProperties": false,
      "required": ["name", "description"],
      "properties": {
        "name": {
          "$ref": "#/$defs/PackageName"
        },
        "description": {
          "$ref": "#/$defs/PackageDescription"
        },
        "comment": {
          "$ref": "#/$defs/PackageComment",
          "default": null
        }
      }
    },
    "VocabularyDependency": {
      "type": "object",
      "title": "Vocabulary Dependency",
      "description": "Dependency to a vocabulary package.",
      "additionalProperties": false,
      "required": ["dependency_type", "package_id"],
      "properties": {
        "dependency_type": {
          "type": "string",
          "const": "vocabulary",
          "title": "Dependency Type",
          "description": "Type of the dependency."
        },
        "package_id": {
          "$ref": "#/$defs/PackageIdentifier"
        }
      }
    },
    "PythonPackageDependency": {
      "type": "object",
      "title": "Python Package Dependency",
      "description": "Dependency to a python plugin package.",
      "additionalProperties": false,
      "required": ["dependency_type", "pypi_id"],
      "properties": {
        "dependency_type": {
          "type": "string",
          "const": "python-package",
          "title": "Dependency Type",
          "description": "Type of the dependency."
        },
        "pypi_id": {
          "$ref": "#/$defs/PyPiIdentifier"
        }
      }
    },
    "ValidDependency": {
      "title": "Dependency",
      "description": "A package dependency specification.",
      "oneOf": [
        { "$ref": "#/$defs/VocabularyDependency" },
        { "$ref": "#/$defs/PythonPackageDependency" }
      ],
      "discriminator": {
        "propertyName": "dependency_type",
        "mapping": {
          "vocabulary": "#/$defs/VocabularyDependency",
          "python-package": "#/$defs/PythonPackageDependency"
        }
      }
    },
    "GraphFileSpec": {
      "type": "object",
      "title": "Graph File Specification",
      "description": "File specification for a graph file. The file_path must end with '.ttl'.",
      "additionalProperties": false,
      "required": ["file_type", "file_path", "graph_iri"],
      "properties": {
        "file_type": {
          "type": "string",
          "const": "graph",
          "title": "File Spec Type",
          "description": "Type of file specification."
        },
        "file_path": {
          "allOf": [
            { "$ref": "#/$defs/FileSpecFilePath" },
            {
              "pattern": "\\.ttl$",
              "description": "Graph files must have .ttl extension."
            }
          ]
        },
        "graph_iri": {
          "$ref": "#/$defs/ResourceIdentifier"
        },
        "import_into": {
          "type": "array",
          "title": "Imported into Graph List",
          "description": "List of Graph IRIs where this current graph needs to be owl:imported after it was uploaded to Corporate Memory.",
          "items": {
            "$ref": "#/$defs/ResourceIdentifier"
          },
          "default": []
        },
        "register_as_vocabulary": {
          "type": "boolean",
          "title": "Register as Vocabulary",
          "description": "A graph with this flag will be registered as a vocabulary.",
          "default": false
        }
      }
    },
    "ProjectFileSpec": {
      "type": "object",
      "title": "Project File Specification",
      "description": "File specification for a project file. The file_path must end with '.zip'.",
      "additionalProperties": false,
      "required": ["file_type", "file_path", "project_id"],
      "properties": {
        "file_type": {
          "type": "string",
          "const": "project",
          "title": "File Spec Type",
          "description": "Type of file specification."
        },
        "file_path": {
          "allOf": [
            { "$ref": "#/$defs/FileSpecFilePath" },
            {
              "pattern": "\\.zip$",
              "description": "Project files must have .zip extension."
            }
          ]
        },
        "project_id": {
          "type": "string",
          "title": "Project ID",
          "description": "Identifier for the project."
        }
      }
    },
    "ValidFileSpec": {
      "title": "File Specification",
      "description": "A file specification for package contents.",
      "oneOf": [
        { "$ref": "#/$defs/GraphFileSpec" },
        { "$ref": "#/$defs/ProjectFileSpec" }
      ],
      "discriminator": {
        "propertyName": "file_type",
        "mapping": {
          "graph": "#/$defs/GraphFileSpec",
          "project": "#/$defs/ProjectFileSpec"
        }
      }
    },
    "VocabularyPackageManifest": {
      "type": "object",
      "title": "Vocabulary Package Manifest",
      "description": "A manifest which describes a vocabulary package. This package type contains a single graph which is registered as a vocabulary. Vocabulary packages do not allow dependencies.",
      "additionalProperties": false,
      "required": ["package_type", "package_id", "package_version", "metadata", "files"],
      "properties": {
        "package_type": {
          "type": "string",
          "const": "vocabulary",
          "title": "Package Type",
          "description": "Type of the package."
        },
        "package_id": {
          "$ref": "#/$defs/PackageIdentifier"
        },
        "package_version": {
          "$ref": "#/$defs/PackageVersionIdentifier"
        },
        "metadata": {
          "$ref": "#/$defs/ManifestMetadata"
        },
        "dependencies": {
          "type": "array",
          "title": "Dependency List",
          "description": "List of dependency specifications. Vocabulary packages do not allow dependencies.",
          "maxItems": 0,
          "default": []
        },
        "files": {
          "type": "array",
          "title": "File List",
          "description": "List of file specifications. Vocabulary packages require exactly one graph file spec with register_as_vocabulary=true.",
          "minItems": 1,
          "maxItems": 1,
          "items": {
            "allOf": [
              { "$ref": "#/$defs/GraphFileSpec" },
              {
                "properties": {
                  "register_as_vocabulary": {
                    "const": true
                  }
                },
                "required": ["register_as_vocabulary"]
              }
            ]
          }
        }
      }
    },
    "ProjectPackageManifest": {
      "type": "object",
      "title": "Project Package Manifest",
      "description": "A manifest which describes a project package. This package type contains multiple graph and project files which work together as a project. File paths and graph IRIs must be unique across all file specs.",
      "additionalProperties": false,
      "required": ["package_type", "package_id", "package_version", "metadata"],
      "properties": {
        "package_type": {
          "type": "string",
          "const": "project",
          "title": "Package Type",
          "description": "Type of the package."
        },
        "package_id": {
          "$ref": "#/$defs/PackageIdentifier"
        },
        "package_version": {
          "$ref": "#/$defs/PackageVersionIdentifier"
        },
        "metadata": {
          "$ref": "#/$defs/ManifestMetadata"
        },
        "dependencies": {
          "type": "array",
          "title": "Dependency List",
          "description": "List of dependency specifications. Package IDs and PyPI IDs must be unique within the list.",
          "items": {
            "$ref": "#/$defs/ValidDependency"
          },
          "default": []
        },
        "files": {
          "type": "array",
          "title": "File List",
          "description": "List of file specifications. File paths and graph IRIs must be unique across all specs.",
          "items": {
            "$ref": "#/$defs/ValidFileSpec"
          },
          "default": []
        }
      }
    }
  }
}
